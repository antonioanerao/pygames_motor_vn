<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Editor de Hist√≥ria (JSON)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      background: #1e1e1e;
      color: #e6e6e6;
    }
    #sidebar {
      width: 45%;
      padding: 20px;
      overflow-y: auto;
      border-right: 2px solid #333;
    }
    #editor {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    h2 {
      border-bottom: 1px solid #444;
      padding-bottom: 4px;
    }
    .scene {
      margin-bottom: 20px;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 6px;
    }
    input, textarea {
      width: 100%;
      padding: 6px;
      margin: 4px 0 10px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #222;
      color: #fff;
    }
    button {
      background: #3c7170;
      border: none;
      color: white;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
    }
    button:hover { background: #4b9b97; }
    pre { background: #111; padding: 10px; border-radius: 6px; overflow-x: auto; }
    .choice-item, .block-item {
      background: #333;
      border-radius: 4px;
      padding: 6px;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>üìú Hist√≥ria carregada</h2>
    <input type="file" id="fileInput" accept=".json">
    <div id="storyDisplay"></div>
    <button id="downloadBtn" style="display:none;">üíæ Baixar JSON atualizado</button>
  </div>

  <div id="editor">
    <h2 id="formTitle">‚úèÔ∏è Criar nova cena</h2>
    <form id="sceneForm">
      <label>Nome da cena:</label>
      <input type="text" id="sceneName" required>

      <div id="blocksContainer"></div>

      <button type="button" id="addBlockBtn">‚ûï Adicionar bloco</button>

      <hr>
      <button type="submit" id="saveSceneBtn">üíæ Adicionar cena</button>
      <button type="button" id="cancelEditBtn" style="display:none;">‚ùå Cancelar edi√ß√£o</button>
    </form>
  </div>

<script>
  let storyData = {};
  let editingScene = null;

  // --- Carregar arquivo JSON ---
  document.getElementById("fileInput").addEventListener("change", function(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      storyData = JSON.parse(e.target.result);
      renderStory();
      document.getElementById("downloadBtn").style.display = "inline-block";
    };
    reader.readAsText(file);
  });

  // --- Renderizar cenas ---
  function renderStory() {
    const container = document.getElementById("storyDisplay");
    container.innerHTML = "";

    for (const [scene, blocks] of Object.entries(storyData)) {
      const div = document.createElement("div");
      div.className = "scene";

      let info = `<strong>${scene}</strong>
        <button title="Editar cena"
          style="float:right; background:none; border:none; color:#aaf; font-size:18px; cursor:pointer;"
          onclick="editScene('${scene}')">‚úèÔ∏è</button>
        <button title="Excluir cena"
          style="float:right; background:none; border:none; color:#aaa; font-size:18px; cursor:pointer; margin-right:8px;"
          onmouseover="this.style.color='red'"
          onmouseout="this.style.color='#aaa'"
          onclick="deleteScene('${scene}')">‚úñ</button><br>`;

      info += `<small><em>Blocos:</em> ${blocks.length}</small><br><br>`;

      blocks.forEach((block, i) => {
        const choices = (block.choices || [])
          .map(ch => {
            const extras = Object.entries(ch)
              .filter(([k]) => !["text", "next", "action"].includes(k))
              .map(([k, v]) => `${k}=${v}`).join(", ");
            return `${ch.text} ‚Üí ${ch.next || "(fim)"} ${ch.action ? "(a√ß√£o: " + ch.action + (extras ? " " + extras : "") + ")" : ""}`;
          })
          .join("<br>");
        info += `<div style="margin-left:10px; margin-bottom:10px;">
          <small><em>Bloco ${i + 1}</em> ‚Äî Speaker: ${block.speaker || "(nenhum)"}</small><br>
          <small><em>Texto:</em> ${block.text || ""}</small><br>
          <small><em>Choices:</em><br>${choices || "(sem choices)"}</small>
        </div>`;
      });

      div.innerHTML = info;
      container.appendChild(div);
    }

    if (Object.keys(storyData).length === 0) {
      container.innerHTML = "<p><em>Nenhuma cena no momento.</em></p>";
    }
  }

  // --- Excluir cena ---
  function deleteScene(sceneName) {
    if (confirm(`Tem certeza que deseja excluir a cena "${sceneName}"?`)) {
      delete storyData[sceneName];
      renderStory();
    }
  }

  // --- Adicionar argumento din√¢mico ---
  function addArgument(container, existing = {}) {
    const argDiv = document.createElement("div");
    argDiv.className = "arg-item";
    argDiv.innerHTML = `
      <label>Nome do argumento:</label>
      <input type="text" class="argKey" value="${existing.key || ""}">
      <label>Valor:</label>
      <input type="text" class="argValue" value="${existing.value || ""}">
      <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
    `;
    container.appendChild(argDiv);
  }

  // --- Adicionar choice ---
  function addChoice(container, existing = {}) {
    const choiceDiv = document.createElement("div");
    choiceDiv.className = "choice-item";
    choiceDiv.innerHTML = `
      <label>Texto da choice:</label>
      <input type="text" class="choiceText" value="${existing.text || ""}">
      <label>Pr√≥xima cena (next):</label>
      <input type="text" class="choiceNext" value="${existing.next || ""}">
      <label>A√ß√£o (opcional):</label>
      <input type="text" class="choiceAction" placeholder="ex: open_link" value="${existing.action || ""}">
      <div class="argsContainer"></div>
      <button type="button" class="addArgBtn">‚ûï Adicionar argumento</button>
      <button type="button" onclick="this.parentElement.remove()">‚ùå Remover choice</button>
      <hr>
    `;
    container.appendChild(choiceDiv);

    // carregar argumentos existentes (se houver)
    const argContainer = choiceDiv.querySelector(".argsContainer");
    Object.entries(existing)
      .filter(([k]) => !["text", "next", "action"].includes(k))
      .forEach(([key, value]) => addArgument(argContainer, { key, value }));

    // evento de adicionar novo argumento
    choiceDiv.querySelector(".addArgBtn").addEventListener("click", () => addArgument(argContainer));
  }

  // --- Adicionar bloco ---
  function addBlock(container, existing = {}) {
    const blockDiv = document.createElement("div");
    blockDiv.className = "block-item";
    const idx = container.children.length;
    blockDiv.innerHTML = `
      <h4>üó®Ô∏è Bloco ${idx + 1}</h4>
      <label>Speaker:</label>
      <input type="text" class="blockSpeaker" value="${existing.speaker || ""}">
      <label>Background:</label>
      <input type="text" class="blockBackground" value="${existing.background || ""}">
      <label>Texto principal:</label>
      <textarea rows="2" class="blockText">${existing.text || ""}</textarea>
      <label>Texto secund√°rio:</label>
      <textarea rows="2" class="blockText2">${existing.text_2 || ""}</textarea>
      <div class="choicesSection">
        <strong>üéØ Choices (opcionais)</strong>
        <div class="choicesContainer"></div>
        <button type="button" class="addChoiceBtn">‚ûï Adicionar choice</button>
      </div>
      <button type="button" onclick="removeBlock(this)">‚ùå Remover bloco</button>
      <hr>
    `;
    container.appendChild(blockDiv);

    // carregar choices existentes (se houver)
    const choiceContainer = blockDiv.querySelector(".choicesContainer");
    (existing.choices || []).forEach(ch => addChoice(choiceContainer, ch));

    // evento de adicionar nova choice
    blockDiv.querySelector(".addChoiceBtn").addEventListener("click", () => addChoice(choiceContainer));
  }

  // --- Editar cena ---
  function editScene(sceneName) {
    editingScene = sceneName;
    const scene = storyData[sceneName];
    document.getElementById("formTitle").innerText = `‚úèÔ∏è Editando: ${sceneName}`;
    document.getElementById("sceneName").value = sceneName;
    document.getElementById("sceneName").disabled = true;

    const container = document.getElementById("blocksContainer");
    container.innerHTML = "";
    scene.forEach(block => addBlock(container, block));

    document.getElementById("cancelEditBtn").style.display = "inline-block";
    document.getElementById("saveSceneBtn").innerText = "üíæ Salvar altera√ß√µes";
  }

  // --- Novo bloco ---
  document.getElementById("addBlockBtn").addEventListener("click", () => {
    addBlock(document.getElementById("blocksContainer"));
  });

  // --- Remover bloco ---
  function removeBlock(btn) {
    btn.parentElement.remove();
  }

  // --- Salvar cena (nova ou editada) ---
  document.getElementById("sceneForm").addEventListener("submit", function(evt) {
    evt.preventDefault();
    const sceneName = document.getElementById("sceneName").value.trim();
    if (!sceneName) return alert("Informe o nome da cena.");

    const blocks = [];
    document.querySelectorAll(".block-item").forEach(blockDiv => {
      const block = {
        speaker: blockDiv.querySelector(".blockSpeaker").value.trim(),
        background: blockDiv.querySelector(".blockBackground").value.trim(),
        text: blockDiv.querySelector(".blockText").value.trim(),
        text_2: blockDiv.querySelector(".blockText2").value.trim(),
        choices: []
      };

      blockDiv.querySelectorAll(".choice-item").forEach(choiceDiv => {
        const text = choiceDiv.querySelector(".choiceText").value.trim();
        const next = choiceDiv.querySelector(".choiceNext").value.trim();
        const action = choiceDiv.querySelector(".choiceAction").value.trim();

        if (text) {
          const choice = { text };
          if (next) choice.next = next;
          if (action) choice.action = action;

          // coletar argumentos adicionais
          choiceDiv.querySelectorAll(".arg-item").forEach(argDiv => {
            const key = argDiv.querySelector(".argKey").value.trim();
            const value = argDiv.querySelector(".argValue").value.trim();
            if (key) choice[key] = value;
          });

          block.choices.push(choice);
        }
      });
      blocks.push(block);
    });

    storyData[sceneName] = blocks;
    renderStory();

    evt.target.reset();
    document.getElementById("blocksContainer").innerHTML = "";
    document.getElementById("sceneName").disabled = false;
    document.getElementById("cancelEditBtn").style.display = "none";
    document.getElementById("saveSceneBtn").innerText = "üíæ Adicionar cena";
    document.getElementById("formTitle").innerText = "‚úèÔ∏è Criar nova cena";
    editingScene = null;
  });

  // --- Cancelar edi√ß√£o ---
  document.getElementById("cancelEditBtn").addEventListener("click", () => {
    document.getElementById("sceneForm").reset();
    document.getElementById("blocksContainer").innerHTML = "";
    document.getElementById("sceneName").disabled = false;
    document.getElementById("cancelEditBtn").style.display = "none";
    document.getElementById("saveSceneBtn").innerText = "üíæ Adicionar cena";
    document.getElementById("formTitle").innerText = "‚úèÔ∏è Criar nova cena";
    editingScene = null;
  });

  // --- Baixar JSON ---
  document.getElementById("downloadBtn").addEventListener("click", function() {
    const blob = new Blob([JSON.stringify(storyData, null, 2)], {type: "application/json"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "historia_editada.json";
    link.click();
  });
</script>


</body>
</html>
